"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _nodeRestClient = _interopRequireDefault(require("@lambdatest/node-rest-client"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('@wdio/lambdatest-service');

class LambdaRestService {
  constructor() {
    this.testCnt = 0;
    this.failures = 0;
  }

  beforeSession(config, capabilities) {
    this.config = config;
    this.capabilities = capabilities;
    const lambdaCredentials = {
      username: this.config.user,
      accessKey: this.config.key
    };

    if (this.config.logFile) {
      lambdaCredentials.logFile = this.config.logFile;
    }

    this.isServiceEnabled = lambdaCredentials.username && lambdaCredentials.accessKey;

    try {
      this.api = _nodeRestClient.default.AutomationClient(lambdaCredentials);
    } catch (_) {
      this.isServiceEnabled = false;
    }
  }

  beforeSuite(suite) {
    this.suiteTitle = suite.title;
  }

  beforeTest(test) {
    if (!this.isServiceEnabled) {
      return;
    }

    if (test.title) {
      this.testTitle = test.title;
    }

    if (this.suiteTitle === 'Jasmine__TopLevel__Suite') {
      this.suiteTitle = test.fullName.slice(0, test.fullName.indexOf(test.title) - 1);
    }
  }

  afterSuite(suite) {
    if (Object.prototype.hasOwnProperty.call(suite, 'error')) {
      ++this.failures;
    }
  }

  afterTest(test, context, {
    error,
    result,
    duration,
    passed,
    retries
  }) {
    console.log(error, result, duration, retries);

    if (!passed) {
      ++this.failures;
    }
  }

  afterScenario(world, {
    passed,
    error,
    duration
  }) {
    console.log(error, duration);

    if (!passed) {
      ++this.failures;
    }
  }

  after(result) {
    if (!this.isServiceEnabled) {
      return;
    }

    let failures = this.failures;

    if (global.browser.config.mochaOpts && global.browser.config.mochaOpts.bail && Boolean(result)) {
      failures = 1;
    }

    console.log("=========result=========", result, result === 0);

    if (result === 0) {
      failures = 0;
    }

    const status = 'status: ' + (failures > 0 ? 'failed' : 'passed');

    if (!global.browser.isMultiremote) {
      log.info(`Update job with sessionId ${global.browser.sessionId}, ${status}`);
      return this._update(global.browser.sessionId, failures);
    }

    return Promise.all(Object.keys(this.capabilities).map(browserName => {
      log.info(`Update multiremote job for browser '${browserName}' and sessionId ${global.browser[browserName].sessionId}, ${status}`);
      return this._update(global.browser[browserName].sessionId, failures, false, browserName);
    }));
  }

  onReload(oldSessionId, newSessionId) {
    if (!this.isServiceEnabled) {
      return;
    }

    const status = 'status: ' + (this.failures > 0 ? 'failed' : 'passed');

    if (!global.browser.isMultiremote) {
      log.info(`Update (reloaded) job with sessionId ${oldSessionId}, ${status}`);
      return this._update(oldSessionId, this.failures, true);
    }

    const browserName = global.browser.instances.filter(browserName => global.browser[browserName].sessionId === newSessionId)[0];
    log.info(`Update (reloaded) multiremote job for browser '${browserName}' and sessionId ${oldSessionId}, ${status}`);
    return this._update(oldSessionId, this.failures, true, browserName);
  }

  async _update(sessionId, failures, calledOnReload = false, browserName) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    await sleep(5000);
    return await this.updateJob(sessionId, failures, calledOnReload, browserName);
  }

  async updateJob(sessionId, failures, calledOnReload = false, browserName) {
    const body = this.getBody(failures, calledOnReload, browserName);

    try {
      await new Promise((resolve, reject) => {
        this.api.updateSessionById(sessionId, body, (err, result) => {
          if (err) {
            return reject(err);
          }

          return resolve(result);
        });
      });
    } catch (ex) {
      console.log(ex);
    }

    this.failures = 0;
  }

  getBody(failures, calledOnReload = false, browserName) {
    let body = {};

    if (!(!global.browser.isMultiremote && this.capabilities.name || global.browser.isMultiremote && this.capabilities[browserName].capabilities.name)) {
      body.name = this.suiteTitle + ' - ' + this.testTitle;

      if (this.capabilities['LT:Options'] && this.capabilities['LT:Options'].name) {
        body.name = this.capabilities['LT:Options'].name;
      }

      if (browserName) {
        body.name = `${browserName}: ${body.name}`;
      }

      if (calledOnReload || this.testCnt) {
        let testCnt = ++this.testCnt;

        if (global.browser.isMultiremote) {
          testCnt = Math.ceil(testCnt / global.browser.instances.length);
        }

        body.name += ` (${testCnt})`;
      }
    }

    body.status_ind = failures > 0 ? 'failed' : 'passed';
    return body;
  }

}

exports.default = LambdaRestService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbImxvZyIsIkxhbWJkYVJlc3RTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJ0ZXN0Q250IiwiZmFpbHVyZXMiLCJiZWZvcmVTZXNzaW9uIiwiY29uZmlnIiwiY2FwYWJpbGl0aWVzIiwibGFtYmRhQ3JlZGVudGlhbHMiLCJ1c2VybmFtZSIsInVzZXIiLCJhY2Nlc3NLZXkiLCJrZXkiLCJsb2dGaWxlIiwiaXNTZXJ2aWNlRW5hYmxlZCIsImFwaSIsIkxhbWJkYVJlc3RDbGllbnQiLCJBdXRvbWF0aW9uQ2xpZW50IiwiXyIsImJlZm9yZVN1aXRlIiwic3VpdGUiLCJzdWl0ZVRpdGxlIiwidGl0bGUiLCJiZWZvcmVUZXN0IiwidGVzdCIsInRlc3RUaXRsZSIsImZ1bGxOYW1lIiwic2xpY2UiLCJpbmRleE9mIiwiYWZ0ZXJTdWl0ZSIsIk9iamVjdCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImFmdGVyVGVzdCIsImNvbnRleHQiLCJlcnJvciIsInJlc3VsdCIsImR1cmF0aW9uIiwicGFzc2VkIiwicmV0cmllcyIsImNvbnNvbGUiLCJhZnRlclNjZW5hcmlvIiwid29ybGQiLCJhZnRlciIsImdsb2JhbCIsImJyb3dzZXIiLCJtb2NoYU9wdHMiLCJiYWlsIiwiQm9vbGVhbiIsInN0YXR1cyIsImlzTXVsdGlyZW1vdGUiLCJpbmZvIiwic2Vzc2lvbklkIiwiX3VwZGF0ZSIsIlByb21pc2UiLCJhbGwiLCJrZXlzIiwibWFwIiwiYnJvd3Nlck5hbWUiLCJvblJlbG9hZCIsIm9sZFNlc3Npb25JZCIsIm5ld1Nlc3Npb25JZCIsImluc3RhbmNlcyIsImZpbHRlciIsImNhbGxlZE9uUmVsb2FkIiwic2xlZXAiLCJtcyIsInIiLCJzZXRUaW1lb3V0IiwidXBkYXRlSm9iIiwiYm9keSIsImdldEJvZHkiLCJyZXNvbHZlIiwicmVqZWN0IiwidXBkYXRlU2Vzc2lvbkJ5SWQiLCJlcnIiLCJleCIsIm5hbWUi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O0FBQ0Q7QUFDRjs7QUFFRG9FLElBQUFBLElBQUksQ0FBQ1csVUFBTCxHQUFrQjlFLFFBQVEsR0FBRyxDQUFYLEdBQWUsUUFBZixHQUEwQixRQUE1QztBQUNBLFdBQU9tRSxJQUFQO0FBQ0Q7O0FBdktvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBMYW1iZGFSZXN0Q2xpZW50IGZyb20gJ0BsYW1iZGF0ZXN0L25vZGUtcmVzdC1jbGllbnQnXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcblxuY29uc3QgbG9nID0gbG9nZ2VyKCdAd2Rpby9sYW1iZGF0ZXN0LXNlcnZpY2UnKVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMYW1iZGFSZXN0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMudGVzdENudCA9IDA7XG4gICAgdGhpcy5mYWlsdXJlcyA9IDA7XG4gIH1cblxuICBiZWZvcmVTZXNzaW9uKGNvbmZpZywgY2FwYWJpbGl0aWVzKSB7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgdGhpcy5jYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXRpZXM7XG4gICAgY29uc3QgbGFtYmRhQ3JlZGVudGlhbHMgPSB7XG4gICAgICB1c2VybmFtZTogdGhpcy5jb25maWcudXNlcixcbiAgICAgIGFjY2Vzc0tleTogdGhpcy5jb25maWcua2V5XG4gICAgfTtcblxuICAgIGlmICh0aGlzLmNvbmZpZy5sb2dGaWxlKSB7XG4gICAgICBsYW1iZGFDcmVkZW50aWFscy5sb2dGaWxlID0gdGhpcy5jb25maWcubG9nRmlsZTtcbiAgICB9XG5cbiAgICB0aGlzLmlzU2VydmljZUVuYWJsZWQgPSBsYW1iZGFDcmVkZW50aWFscy51c2VybmFtZSAmJiBsYW1iZGFDcmVkZW50aWFscy5hY2Nlc3NLZXk7XG5cbiAgICB0cnkge1xuICAgICAgdGhpcy5hcGkgPSBMYW1iZGFSZXN0Q2xpZW50LkF1dG9tYXRpb25DbGllbnQobGFtYmRhQ3JlZGVudGlhbHMpO1xuICAgIH0gY2F0Y2ggKF8pIHtcbiAgICAgIHRoaXMuaXNTZXJ2aWNlRW5hYmxlZCA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGJlZm9yZVN1aXRlKHN1aXRlKSB7XG4gICAgdGhpcy5zdWl0ZVRpdGxlID0gc3VpdGUudGl0bGU7XG4gIH1cblxuICBiZWZvcmVUZXN0KHRlc3QpIHtcbiAgICBpZiAoIXRoaXMuaXNTZXJ2aWNlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGVzdC50aXRsZSl7XG4gICAgICB0aGlzLnRlc3RUaXRsZSA9IHRlc3QudGl0bGVcbiAgICB9XG4gICAgXG4gICAgaWYgKHRoaXMuc3VpdGVUaXRsZSA9PT0gJ0phc21pbmVfX1RvcExldmVsX19TdWl0ZScpIHtcbiAgICAgIHRoaXMuc3VpdGVUaXRsZSA9IHRlc3QuZnVsbE5hbWUuc2xpY2UoMCwgdGVzdC5mdWxsTmFtZS5pbmRleE9mKHRlc3QudGl0bGUpIC0gMSk7XG4gICAgfVxuICB9XG5cbiAgYWZ0ZXJTdWl0ZShzdWl0ZSkge1xuICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3VpdGUsICdlcnJvcicpKSB7XG4gICAgICArK3RoaXMuZmFpbHVyZXM7XG4gICAgfVxuICB9XG5cbiAgYWZ0ZXJUZXN0KHRlc3QsIGNvbnRleHQsIHtcbiAgICBlcnJvcixcbiAgICByZXN1bHQsXG4gICAgZHVyYXRpb24sXG4gICAgcGFzc2VkLFxuICAgIHJldHJpZXNcbiAgfSkge1xuICAgIGNvbnNvbGUubG9nKGVycm9yLCByZXN1bHQsIGR1cmF0aW9uLCByZXRyaWVzKVxuICAgIGlmICghcGFzc2VkKSB7XG4gICAgICArK3RoaXMuZmFpbHVyZXM7XG4gICAgfVxuICB9XG5cbiAgYWZ0ZXJTY2VuYXJpbyh3b3JsZCwgeyBwYXNzZWQsIGVycm9yLCBkdXJhdGlvbiB9KSB7XG4gICAgY29uc29sZS5sb2coZXJyb3IsIGR1cmF0aW9uKVxuICAgIGlmICghcGFzc2VkKSB7XG4gICAgICArK3RoaXMuZmFpbHVyZXM7XG4gICAgfVxuICB9XG5cbiAgYWZ0ZXIocmVzdWx0KSB7XG4gICAgaWYgKCF0aGlzLmlzU2VydmljZUVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgZmFpbHVyZXMgPSB0aGlzLmZhaWx1cmVzO1xuXG4gICAgaWYgKGdsb2JhbC5icm93c2VyLmNvbmZpZy5tb2NoYU9wdHMgJiYgZ2xvYmFsLmJyb3dzZXIuY29uZmlnLm1vY2hhT3B0cy5iYWlsICYmIEJvb2xlYW4ocmVzdWx0KSkge1xuICAgICAgZmFpbHVyZXMgPSAxO1xuICAgIH1cbiAgICBjb25zb2xlLmxvZyhcIj09PT09PT09PXJlc3VsdD09PT09PT09PVwiLCByZXN1bHQsIHJlc3VsdCA9PT0gMClcbiAgICBpZiAocmVzdWx0ID09PSAwKSB7XG4gICAgICBmYWlsdXJlcyA9IDA7XG4gICAgfVxuICAgIGNvbnN0IHN0YXR1cyA9ICdzdGF0dXM6ICcgKyAoZmFpbHVyZXMgPiAwID8gJ2ZhaWxlZCcgOiAncGFzc2VkJyk7XG5cbiAgICBpZiAoIWdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUpIHtcbiAgICAgIGxvZy5pbmZvKGBVcGRhdGUgam9iIHdpdGggc2Vzc2lvbklkICR7Z2xvYmFsLmJyb3dzZXIuc2Vzc2lvbklkfSwgJHtzdGF0dXN9YCk7XG4gICAgICByZXR1cm4gdGhpcy5fdXBkYXRlKGdsb2JhbC5icm93c2VyLnNlc3Npb25JZCwgZmFpbHVyZXMpO1xuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLmFsbChPYmplY3Qua2V5cyh0aGlzLmNhcGFiaWxpdGllcykubWFwKGJyb3dzZXJOYW1lID0+IHtcbiAgICAgIGxvZy5pbmZvKGBVcGRhdGUgbXVsdGlyZW1vdGUgam9iIGZvciBicm93c2VyICcke2Jyb3dzZXJOYW1lfScgYW5kIHNlc3Npb25JZCAke2dsb2JhbC5icm93c2VyW2Jyb3dzZXJOYW1lXS5zZXNzaW9uSWR9LCAke3N0YXR1c31gKTtcbiAgICAgIHJldHVybiB0aGlzLl91cGRhdGUoZ2xvYmFsLmJyb3dzZXJbYnJvd3Nlck5hbWVdLnNlc3Npb25JZCwgZmFpbHVyZXMsIGZhbHNlLCBicm93c2VyTmFtZSk7XG4gICAgfSkpO1xuICB9XG5cbiAgb25SZWxvYWQob2xkU2Vzc2lvbklkLCBuZXdTZXNzaW9uSWQpIHtcbiAgICBpZiAoIXRoaXMuaXNTZXJ2aWNlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXR1cyA9ICdzdGF0dXM6ICcgKyAodGhpcy5mYWlsdXJlcyA+IDAgPyAnZmFpbGVkJyA6ICdwYXNzZWQnKTtcblxuICAgIGlmICghZ2xvYmFsLmJyb3dzZXIuaXNNdWx0aXJlbW90ZSkge1xuICAgICAgbG9nLmluZm8oYFVwZGF0ZSAocmVsb2FkZWQpIGpvYiB3aXRoIHNlc3Npb25JZCAke29sZFNlc3Npb25JZH0sICR7c3RhdHVzfWApO1xuICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShvbGRTZXNzaW9uSWQsIHRoaXMuZmFpbHVyZXMsIHRydWUpO1xuICAgIH1cblxuICAgIGNvbnN0IGJyb3dzZXJOYW1lID0gZ2xvYmFsLmJyb3dzZXIuaW5zdGFuY2VzLmZpbHRlcihicm93c2VyTmFtZSA9PiBnbG9iYWwuYnJvd3Nlclticm93c2VyTmFtZV0uc2Vzc2lvbklkID09PSBuZXdTZXNzaW9uSWQpWzBdO1xuICAgIGxvZy5pbmZvKGBVcGRhdGUgKHJlbG9hZGVkKSBtdWx0aXJlbW90ZSBqb2IgZm9yIGJyb3dzZXIgJyR7YnJvd3Nlck5hbWV9JyBhbmQgc2Vzc2lvbklkICR7b2xkU2Vzc2lvbklkfSwgJHtzdGF0dXN9YCk7XG4gICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShvbGRTZXNzaW9uSWQsIHRoaXMuZmFpbHVyZXMsIHRydWUsIGJyb3dzZXJOYW1lKTtcbiAgfVxuXG4gIGFzeW5jIF91cGRhdGUgKCBzZXNzaW9uSWQsIGZhaWx1cmVzLCBjYWxsZWRPblJlbG9hZCA9IGZhbHNlLCBicm93c2VyTmFtZSApIHtcbiAgICBjb25zdCBzbGVlcCA9IG1zID0+IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCBtcykpO1xuICAgIFxuICAgIGF3YWl0IHNsZWVwKDUwMDApXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudXBkYXRlSm9iKHNlc3Npb25JZCwgZmFpbHVyZXMsIGNhbGxlZE9uUmVsb2FkLCBicm93c2VyTmFtZSk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVKb2Ioc2Vzc2lvbklkLCBmYWlsdXJlcywgY2FsbGVkT25SZWxvYWQgPSBmYWxzZSwgYnJvd3Nlck5hbWUpIHtcbiAgICBjb25zdCBib2R5ID0gdGhpcy5nZXRCb2R5KGZhaWx1cmVzLCBjYWxsZWRPblJlbG9hZCwgYnJvd3Nlck5hbWUpO1xuICAgIHRyeXtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmFwaS51cGRhdGVTZXNzaW9uQnlJZChzZXNzaW9uSWQsIGJvZHksIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzdWx0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIGNhdGNoKGV4KXtcbiAgICBjb25zb2xlLmxvZyhleCk7XG4gIH1cbiAgICB0aGlzLmZhaWx1cmVzID0gMDtcbiAgfVxuXG4gIGdldEJvZHkoZmFpbHVyZXMsIGNhbGxlZE9uUmVsb2FkID0gZmFsc2UsIGJyb3dzZXJOYW1lKSB7XG4gICAgbGV0IGJvZHkgPSB7fTtcbiAgICBpZiAoISghZ2xvYmFsLmJyb3dzZXIuaXNNdWx0aXJlbW90ZSAmJiB0aGlzLmNhcGFiaWxpdGllcy5uYW1lIHx8IGdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUgJiYgdGhpcy5jYXBhYmlsaXRpZXNbYnJvd3Nlck5hbWVdLmNhcGFiaWxpdGllcy5uYW1lKSkge1xuICAgICAgXG4gICAgICBib2R5Lm5hbWUgPSB0aGlzLnN1aXRlVGl0bGUgKyAnIC0gJyArIHRoaXMudGVzdFRpdGxlXG4gICAgICBcbiAgICAgIGlmICh0aGlzLmNhcGFiaWxpdGllc1snTFQ6T3B0aW9ucyddICYmIHRoaXMuY2FwYWJpbGl0aWVzWydMVDpPcHRpb25zJ10ubmFtZSl7XG4gICAgICAgIGJvZHkubmFtZSA9IHRoaXMuY2FwYWJpbGl0aWVzWydMVDpPcHRpb25zJ10ubmFtZVxuICAgICAgfVxuICAgICAgXG4gICAgICBpZiAoYnJvd3Nlck5hbWUpIHtcbiAgICAgICAgYm9keS5uYW1lID0gYCR7YnJvd3Nlck5hbWV9OiAke2JvZHkubmFtZX1gO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2FsbGVkT25SZWxvYWQgfHwgdGhpcy50ZXN0Q250KSB7XG4gICAgICAgIGxldCB0ZXN0Q250ID0gKyt0aGlzLnRlc3RDbnQ7XG5cbiAgICAgICAgaWYgKGdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUpIHtcbiAgICAgICAgICB0ZXN0Q250ID0gTWF0aC5jZWlsKHRlc3RDbnQgLyBnbG9iYWwuYnJvd3Nlci5pbnN0YW5jZXMubGVuZ3RoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGJvZHkubmFtZSArPSBgICgke3Rlc3RDbnR9KWA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgYm9keS5zdGF0dXNfaW5kID0gZmFpbHVyZXMgPiAwID8gJ2ZhaWxlZCcgOiAncGFzc2VkJztcbiAgICByZXR1cm4gYm9keTtcbiAgfVxuXG59XG4iXX0=